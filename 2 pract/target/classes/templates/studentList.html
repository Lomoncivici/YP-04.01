<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Студенты</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px;}
        table { border-collapse: collapse; width: 100%; margin-top: 10px;}
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f0f0f0; }
        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .pagination { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .deleted { color: #888; text-decoration: line-through; }
    </style>
</head>
<body>
<h1>Список студентов</h1>

<div class="toolbar">
    <form method="get" action="/students">
        <input type="text" name="q" placeholder="Поиск по имени/фамилии/отчеству" th:value="${q}"/>
        <select name="courseId">
            <option value="">Курс: любой</option>
            <option th:each="c : ${courses}" th:value="${c.id}" th:text="${c.title}"
                    th:selected="${courseId != null and courseId == c.id}"></option>
        </select>
        <select name="deleted">
            <option value="">Статус: любой</option>
            <option th:value="false" th:selected="${deleted == false}">Активные</option>
            <option th:value="true"  th:selected="${deleted == true}">Удалённые</option>
        </select>
        <input type="number" name="size" min="10" step="1" th:value="${size}" title="Размер страницы (min 10)"/>
        <input type="hidden" name="page" th:value="${page}"/>
        <button type="submit">Применить</button>
    </form>

    <a href="/courses">Управление курсами</a>
</div>

<form method="post" action="/students/add" style="margin-top:16px;">
    <!-- CSRF: добавляем только если объект есть -->
    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <input type="text" name="name" placeholder="Имя" required/>
    <input type="text" name="lastName" placeholder="Фамилия" required/>
    <input type="text" name="firstName" placeholder="Отчество" required/>
    <select name="courseId" required>
        <option value="" disabled selected>Курс</option>
        <option th:each="c : ${courses}" th:value="${c.id}" th:text="${c.title}"></option>
    </select>
    <button type="submit">Добавить</button>
</form>

<!-- Отдельная форма для пакетного удаления -->
<form id="batchDeleteForm" method="post" action="/students/delete-batch" style="margin-top:12px;">
    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <label>
        <select name="type">
            <option value="logical">Логическое удаление</option>
            <option value="physical">Физическое удаление</option>
        </select>
    </label>
    <button type="submit">Удалить выбранные</button>
</form>

<table>
    <thead>
    <tr>
        <th>
            <input type="checkbox"
                   onclick="document.querySelectorAll('.row-check').forEach(cb => cb.checked=this.checked)"/>
        </th>
        <th>ID</th>
        <th>ФИО</th>
        <th>Курс</th>
        <th>Статус</th>
        <th>Действия</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="s : ${students}">
        <!-- ВАЖНО: чекбокс привязан к batchDeleteForm -->
        <td><input class="row-check" type="checkbox" name="ids" th:value="${s.id}" form="batchDeleteForm"/></td>
        <td th:text="${s.id}"></td>
        <td>
        <span th:classappend="${s.deleted} ? 'deleted'">
          <span th:text="${s.lastName + ' ' + s.name + ' ' + s.firstName}"></span>
        </span>
        </td>
        <td>
        <span th:each="c : ${courses}"
              th:if="${c.id == s.courseId}"
              th:text="${c.title}">—</span>
        </td>
        <td th:text="${s.deleted} ? 'Удалён' : 'Активен'"></td>
        <td>
            <form method="post" action="/students/update" style="display:inline-block;">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="id" th:value="${s.id}"/>
                <input type="text" name="name"       th:placeholder="${s.name}" required/>
                <input type="text" name="lastName"   th:placeholder="${s.lastName}" required/>
                <input type="text" name="firstName"  th:placeholder="${s.firstName}" required/>
                <select name="courseId" required>
                    <option th:each="c : ${courses}"
                            th:value="${c.id}"
                            th:selected="${c.id == s.courseId}"
                            th:text="${c.title}"></option>
                </select>
                <button type="submit">Обновить</button>
            </form>

            <form method="post" action="/students/delete" style="display:inline-block;">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="id" th:value="${s.id}"/>
                <button type="submit">Лог. удалить</button>
            </form>

            <form method="post" action="/students/delete-physical" style="display:inline-block;">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="id" th:value="${s.id}"/>
                <button type="submit">Физ. удалить</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

<div class="pagination">
    <a th:each="p : ${#numbers.sequence(1, totalPages)}"
       th:href="@{/students(page=${p}, size=${size}, q=${q}, courseId=${courseId}, deleted=${deleted}, lastNamePrefix=${lastNamePrefix})}"
       th:text="${p}"
       th:style="${p == page} ? 'font-weight:bold; text-decoration:underline;' : ''"></a>
</div>

<p th:text="'Всего записей: ' + ${total} + ', страниц: ' + ${totalPages}"></p>

</body>
</html>
