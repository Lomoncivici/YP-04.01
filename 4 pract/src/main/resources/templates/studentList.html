<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Студенты</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px;}
        table { border-collapse: collapse; width: 100%; margin-top: 10px;}
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f0f0f0; }
        .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .pagination { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .deleted { color: #888; text-decoration: line-through; }
    </style>
</head>
<body>
<h1>Список студентов</h1>

<div class="toolbar">
    <form method="get" th:action="@{/students}">
        <input type="text" name="q" placeholder="Поиск по ФИО" th:value="${q}"/>

        <select name="courseId">
            <option value="">Все курсы</option>
            <option th:each="c : ${courses}"
                    th:value="${c.id}"
                    th:text="${c.title}"
                    th:selected="${courseId != null and courseId == c.id}">
            </option>
        </select>

        <label style="margin-left:8px;">
            <input type="checkbox" name="onlyActive" th:checked="${onlyActive}"> Только активные
        </label>

        <select name="sort">
            <option value="lastName"  th:selected="${sort == 'lastName'}">Фамилия</option>
            <option value="firstName" th:selected="${sort == 'firstName'}">Имя</option>
            <option value="id"        th:selected="${sort == 'id'}">ID</option>
        </select>
        <select name="dir">
            <option value="asc"  th:selected="${dir == 'asc'}">↑</option>
            <option value="desc" th:selected="${dir == 'desc'}">↓</option>
        </select>

        <button type="submit">Применить</button>
    </form>

    <div sec:authorize="hasRole('ADMIN')">
        <a th:href="@{/courses}">Управление курсами</a>
        <a th:href="@{/departments}">Кафедры</a>
        <a th:href="@{/tags}">Теги</a>
    </div>
</div>

<div class="toolbar">
    <form th:action="@{/logout}" method="post" style="margin-left:auto;">
        <button type="submit">Выход</button>
    </form>
</div>

<div sec:authorize="hasRole('ADMIN')">
    <form method="post" th:action="@{/students/add}" style="margin-top:16px;" th:object="${student}">
    <input type="text" th:field="*{lastName}"  placeholder="Фамилия" required/>
    <input type="text" th:field="*{firstName}" placeholder="Имя" required/>
    <input type="text" th:field="*{middleName}" placeholder="Отчество"/>
    <select th:field="*{course}" required>
        <option th:each="c : ${courses}" th:value="${c.id}" th:text="${c.title}"></option>
    </select>
    <button type="submit">Добавить</button>
</form>
</div>

<table>
    <thead>
    <tr>
        <th>ID</th><th>Фамилия</th><th>Имя</th><th>Отчество</th><th>Курс</th><th>Статус</th><th>Действия</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="s : ${page.content}" th:classappend="${s.deleted} ? 'deleted'">
        <td th:text="${s.id}"></td>
        <td th:text="${s.lastName}"></td>
        <td th:text="${s.firstName}"></td>
        <td th:text="${s.middleName}"></td>
        <td th:text="${s.course.title}"></td>
        <td th:text="${s.deleted} ? 'удалён' : 'активен'"></td>
        <td>
            <div sec:authorize="hasRole('ADMIN')">
            <form method="post" th:action="@{/students/soft-delete}" style="display:inline-block;" th:if="${!s.deleted}">
                <input type="hidden" name="id" th:value="${s.id}"/>
                <button>Лог. удалить</button>
            </form>
            <form method="post" th:action="@{/students/hard-delete}" style="display:inline-block;">
                <input type="hidden" name="id" th:value="${s.id}"/>
                <button>Физ. удалить</button>
            </form>
            </div>
        </td>
    </tr>
    </tbody>
</table>

<div class="pagination">
    <a th:if="${!page.first}"
       th:href="@{/students(
        pageIndex=${page.number - 1},
        size=${page.size},
        q=${q},
        courseId=${courseId},
        onlyActive=${onlyActive},
        sort=${sort},
        dir=${dir}
     )}">« Назад</a>

    <span th:text="${page.totalPages > 0 ? (page.number + 1) + ' / ' + page.totalPages : '0 / 0'}"></span>

    <a th:if="${!page.last}"
       th:href="@{/students(
        pageIndex=${page.number + 1},
        size=${page.size},
        q=${q},
        courseId=${courseId},
        onlyActive=${onlyActive},
        sort=${sort},
        dir=${dir}
     )}">Вперёд »</a>
</div>

</body>
</html>

<script>
    (function() {
        const IDLE_LIMIT_MS = 30 * 1000; // 30 секунд
        let lastActivity = Date.now();

        function resetTimer() {
            lastActivity = Date.now();
        }

        ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
            document.addEventListener(evt, resetTimer, {passive: true});
        });

        setInterval(function () {
            const now = Date.now();
            if (now - lastActivity > IDLE_LIMIT_MS) {
                fetch('/logout', { method: 'POST' })
                    .finally(() => {
                        window.location.href = '/login?idle';
                    });
            }
        }, 5000);
    })();
</script>
