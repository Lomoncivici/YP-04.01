<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>Кафедры</title>
    <style>
        body{font-family:Arial;margin:20px}
        table{border-collapse:collapse;width:100%;margin-top:10px}
        th,td{border:1px solid #ddd;padding:8px} th{background:#f0f0f0}
        .deleted{color:#888;text-decoration:line-through}
        .pagination{margin-top:10px;display:flex;gap:8px}
        .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    </style>
</head>
<body>
<h1>Кафедры</h1>
<a th:href="@{/students}">← к студентам</a>

<form method="get" th:action="@{/departments}" style="margin-top:10px">
  <label><input type="checkbox" name="onlyActive" th:checked="${onlyActive}"> Только активные</label>
  <select name="sort">
    <option value="name" th:selected="${sort == 'name'}">Название</option>
    <option value="id"   th:selected="${sort == 'id'}">ID</option>
  </select>
  <select name="dir">
    <option value="asc"  th:selected="${dir == 'asc'}">↑</option>
    <option value="desc" th:selected="${dir == 'desc'}">↓</option>
  </select>
  <button type="submit">Применить</button>
</form>

<div class="toolbar">
    <form th:action="@{/logout}" method="post" style="margin-left:auto;">
        <button type="submit">Выход</button>
    </form>
</div>

<div sec:authorize="hasRole('ADMIN')">
<h3>Добавить кафедру</h3>
<form method="post" th:action="@{/departments/add}" th:object="${dept}">
  <input type="text" th:field="*{name}" placeholder="Название" required/>
  <button type="submit">Сохранить</button>
</form>
</div>

<table>
  <thead><tr><th>ID</th><th>Название</th><th>Статус</th><th>Действия</th></tr></thead>
  <tbody>
    <tr th:each="d : ${page.content}" th:classappend="${d.deleted} ? 'deleted'">
      <td th:text="${d.id}"></td>
      <td th:text="${d.name}"></td>
      <td th:text="${d.deleted} ? 'удалена' : 'активна'"></td>
      <td>
        <div sec:authorize="hasRole('ADMIN')">
        <form method="post" th:action="@{/departments/soft-delete}" th:if="${!d.deleted}" style="display:inline-block">
          <input type="hidden" name="id" th:value="${d.id}"/>
          <button>Лог. удалить</button>
        </form>
        <form method="post" th:action="@{/departments/hard-delete}" style="display:inline-block">
          <input type="hidden" name="id" th:value="${d.id}"/>
          <button>Физ. удалить</button>
        </form>
        </div>
      </td>
    </tr>
  </tbody>
</table>

<div class="pagination">
    <a th:if="${!page.first}"
       th:href="@{/departments(
         pageIndex=${page.number - 1},
         size=${page.size},
         onlyActive=${onlyActive},
         sort=${sort},
         dir=${dir}
     )}">« Назад</a>

    <span>
    <span th:text="${page.number + 1}">1</span>
    /
    <span th:text="${page.totalPages}">1</span>
  </span>

    <a th:if="${!page.last}"
       th:href="@{/departments(
         pageIndex=${page.number + 1},
         size=${page.size},
         onlyActive=${onlyActive},
         sort=${sort},
         dir=${dir}
     )}">Вперёд »</a>
</div>


</body>
</html>

<script>
    (function() {
        const IDLE_LIMIT_MS = 30 * 1000; // 30 секунд
        let lastActivity = Date.now();

        function resetTimer() {
            lastActivity = Date.now();
        }

        ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
            document.addEventListener(evt, resetTimer, {passive: true});
        });

        setInterval(function () {
            const now = Date.now();
            if (now - lastActivity > IDLE_LIMIT_MS) {
                fetch('/logout', { method: 'POST' })
                    .finally(() => {
                        window.location.href = '/login?idle';
                    });
            }
        }, 5000); // раз в 5 секунд проверка
    })();
</script>
